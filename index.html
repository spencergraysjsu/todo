<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Productivity Hub</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✅</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MathJax configuration: LaTeX + amsmath, common delimiters, escaping -->
  <script>
    window.MathJax = {
      loader: { load: ['[tex]/ams'] },
      tex: {
        packages: { '[+]': ['ams'] },
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        tags: 'ams'
      }
    };
  </script>
  <!-- MathJax v3 (TeX + CHTML). Keep async; our code typesets per-message. -->
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    body, .bg-gray-100 { background-color: #f3f4f6; transition: background-color 0.3s ease; }
    .task-list-item-text.completed { text-decoration: line-through; color: #9ca3af; }
    .modal-content { animation: fadeIn 0.3s ease-out; position: fixed; z-index: 50; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    #main-container.calendar-view { max-width: 90vw; }

    /* Dark mode */
    .dark body, .dark .bg-gray-100 { background-color: #1a202c; }
    .dark .bg-white { background-color: #2d3748; }
    .dark .text-gray-800 { color: #e2e8f0; }
    .dark .text-gray-500, .dark .text-gray-700, .dark .text-gray-600 { color: #a0aec0; }
    .dark .border-gray-300, .dark .border-gray-200 { border-color: #4a5568; }
    .dark .animated-input { background-color: #4a5568; color: #e2e8f0; }
    .dark .bg-gray-50 { background-color: #2d3748; }
    .dark .shadow-2xl, .dark .shadow-xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 0, 0, 0.3); }

    /* Ensure math inherits text color nicely in both themes */
    mjx-container[jax="CHTML"] { line-height: 1.3; }
    .dark mjx-container[jax="CHTML"] { color: inherit; }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.95);} to { opacity: 1; transform: translate(-50%, -50%) scale(1);} }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-20px);} to { opacity: 1; transform: translateY(0);} }
    @keyframes fadeOut { from { opacity: 1; transform: scale(1);} to { opacity: 0; transform: scale(0.95);} }

    /* Focus style */
    .animated-input:focus { box-shadow: 0 0 0 4px rgba(59,130,246,.3); border-color: #3b82f6; }

    .drag-handle { cursor: move; -webkit-user-drag: none; user-select: none; }
    .subtasks-container { margin-top: 1rem; padding-left: 2rem; animation: slideIn .3s ease-out; overflow: hidden; max-height: 0; opacity: 0; }
    .subtasks-container.expanded { max-height: 500px; opacity: 1; }
    .spinner { border: 2px solid rgba(255,255,255,.3); border-top: 2px solid white; border-radius: 50%; width:1rem; height:1rem; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
    .rotate-90 { transform: rotate(90deg); }
    .rotate-180 { transform: rotate(180deg); }

    .dropdown-content { max-height: 0; overflow: hidden; transition: max-height .3s ease-out, padding .3s ease-out; padding-left: 1rem; padding-right: 1rem; }
    .dropdown-content.open { max-height: 500px; padding-top: 1rem; padding-bottom: 1rem; }

    .chat-container { height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 1rem; display: flex; flex-direction: column; gap: .5rem; margin-bottom: 1rem; }
    .user-message { background-color: #3b82f6; color: white; padding: .75rem 1rem; border-radius: 1.5rem 1.5rem .5rem 1.5rem; align-self: flex-end; max-width: 80%; }
    .gemini-message { background-color: #e2e8f0; color: #2d3748; padding: .75rem 1rem; border-radius: 1.5rem 1.5rem 1.5rem .5rem; align-self: flex-start; max-width: 80%; }
    .dark .gemini-message { background-color: #4a5568; color: #e2e8f0; }

    .resize-handle { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; background: #60a5fa; cursor: nwse-resize; border-bottom-right-radius: 1rem; }

    /* Toggle switch */
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #2196F3; }
    input:checked + .slider:before { transform: translateX(22px); }

    /* Particles Canvas */
    #particles-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .floating-logo { position: fixed; z-index: -1; width: 150px; height: 150px; object-fit: contain; transition: opacity .3s ease; }

    /* Calendar + tabs */
    .tabs-container { border-bottom: 2px solid #e5e7eb; margin-bottom: 1.5rem; }
    .dark .tabs-container { border-bottom-color: #4a5568; }
    .tab-button { padding: .75rem 1.5rem; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: color .2s ease, border-color .2s ease; }
    .dark .tab-button { color: #a0aec0; }
    .tab-button.active { color: #3b82f6; border-bottom-color: #3b82f6; }
    .dark .tab-button.active { color: #60a5fa; border-bottom-color: #60a5fa; }

    .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap: 4px; }
    .calendar-header-cell, .calendar-day-cell { text-align:center; padding: .5rem; border-radius: .5rem; }
    .calendar-header-cell { font-weight: 700; color: #4b5563; }
    .dark .calendar-header-cell { color: #cbd5e0; }
    .calendar-day-cell { min-height: 100px; background-color: #f9fafb; border: 1px solid #e5e7eb; transition: background-color .2s ease; cursor: pointer; }
    .dark .calendar-day-cell { background-color: #4a5568; border-color: #718096; }
    .calendar-day-cell.is-today { background-color: #dbeafe; border-color: #93c5fd; }
    .dark .calendar-day-cell.is-today { background-color: #2b6cb0; border-color: #4299e1; }
    .calendar-day-cell.is-other-month .day-number { color: #d1d5db; }
    .dark .calendar-day-cell.is-other-month .day-number { color: #718096; }
    .day-number { font-weight: 600; }
    .calendar-task, .calendar-event { font-size: .75rem; padding: 2px 6px; margin-top: 4px; border-radius: 9999px; color: white; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .calendar-task { background-color: #3b82f6; }
    .calendar-task.completed { background-color: #6b7280; text-decoration: line-through; }

    .color-picker { display: flex; gap: .5rem; margin-top: .5rem; }
    .color-option { width: 2rem; height: 2rem; border-radius: 9999px; cursor: pointer; border: 2px solid transparent; }
    .color-option.selected { border-color: #3b82f6; }
    .bg-red-500 { background-color: #ef4444; }
    .bg-blue-500 { background-color: #3b82f6; }
    .bg-green-500 { background-color: #22c55e; }
    .bg-yellow-500 { background-color: #eab308; }
    .bg-purple-500 { background-color: #8b5cf6; }

    .complete-tasks-container { margin-top: 2rem; border-top: 2px solid #e5e7eb; padding-top: 1.5rem; }
    .dark .complete-tasks-container { border-top-color: #4a5568; }

    /* Clock */
    #live-clock { position: fixed; top: 20px; left: calc(100vw - 200px); width: auto; background-color: rgba(255,255,255,.8); padding: 1rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); z-index: 100; }
    .dark #live-clock { background-color: rgba(45,55,72,.8); }
    #digital-clock { font-size: 2rem; font-weight: 700; color: #374151; }
    .dark #digital-clock { color: #e2e8f0; }
    #analog-clock { width: 150px; height: 150px; border: 5px solid #374151; border-radius: 50%; position: relative; }
    .dark #analog-clock { border-color: #e2e8f0; }
    .hand { position: absolute; background-color: #374151; transform-origin: bottom; border-radius: 2px; left: 50%; bottom: 50%; }
    .dark .hand { background-color: #e2e8f0; }
    #hour-hand { width: 4px; height: 40px; }
    #minute-hand { width: 3px; height: 60px; }
    #second-hand { width: 2px; height: 70px; background-color: #ef4444; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <!-- AUTH VIEW (shown when signed out) -->
  <div id="auth-view" class="w-full max-w-md mx-auto p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-6">
      <h2 class="text-2xl font-bold mb-2 text-gray-800 text-center">Welcome</h2>
      <p class="text-sm text-gray-500 text-center mb-6">Log in or create an account to sync your data.</p>
      <form id="auth-form" class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="auth-email">Email</label>
          <input id="auth-email" type="email" required class="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 animated-input" placeholder="you@example.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="auth-password">Password</label>
          <input id="auth-password" type="password" required minlength="6" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 animated-input" placeholder="••••••••">
        </div>
        <button id="auth-submit" type="submit" class="w-full bg-blue-500 text-white p-3 rounded-xl shadow-lg hover:bg-blue-600 transition-all duration-200">Log in</button>
      </form>
      <div class="flex items-center justify-between mt-4 text-sm">
        <span id="auth-mode-text" class="text-gray-600">New here?</span>
        <button id="toggle-auth-mode" class="text-blue-600 hover:underline">Create an account</button>

        <button id="sign-out-button" class="p-2 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 hidden" title="Sign out">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6A2.25 2.25 0 005.25 5.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/>
          </svg>
        </button>
      </div>
      <p id="auth-error" class="text-red-600 text-sm mt-3 hidden"></p>
    </div>
  </div>
  <!-- END AUTH VIEW -->

  <!-- APP VIEW (hidden until signed in) -->
  <div id="app-view" class="hidden w-full min-h-screen flex items-center justify-center">

    <canvas id="particles-canvas"></canvas>
    <img id="floating-logo" class="floating-logo hidden" src="" alt="Floating Logo">

    <div id="live-clock" class="hidden">
      <div id="clock-drag-handle" class="drag-handle text-center text-gray-500 cursor-move mb-2">::</div>
      <div id="digital-clock"></div>
      <div id="analog-clock" class="hidden">
        <div id="hour-hand" class="hand"></div>
        <div id="minute-hand" class="hand"></div>
        <div id="second-hand" class="hand"></div>
      </div>
    </div>

    <div id="main-container" class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl w-full max-w-4xl z-10">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">My Productivity Hub</h1>
        <div class="flex items-center space-x-2">
          <span id="user-email" class="hidden md:inline text-sm text-gray-500 mr-2"></span>
          <button id="gemini-button" class="p-2 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
            </svg>
          </button>
          <button id="settings-button" class="p-2 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 2a10 10 0 100 20 10 10 0 000-20zM12 15a3 3 0 100-6 3 3 0 000 6z"/>
            </svg>
          </button>

          <button id="sign-out-button" class="p-2 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 hidden" title="Sign out">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6A2.25 2.25 0 005.25 5.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="tabs-container flex">
        <button id="todo-tab-button" class="tab-button active">To-Do List</button>
        <button id="calendar-tab-button" class="tab-button">Calendar</button>
      </div>

      <div id="todo-panel">
        <form id="task-form" class="mb-6 flex items-center space-x-2">
          <input type="text" id="task-input" placeholder="Add a new task..." required class="animated-input flex-grow p-3 border-2 border-gray-300 rounded-xl focus:outline-none transition-colors duration-200">
          <button type="submit" class="bg-blue-500 text-white p-3 rounded-xl shadow-lg hover:bg-blue-600 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
            </svg>
          </button>
        </form>

        <ul id="task-list" class="space-y-4"></ul>

        <div id="complete-tasks" class="complete-tasks-container hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Completed</h2>
          <ul id="completed-task-list" class="space-y-4"></ul>
        </div>
      </div>

      <div id="calendar-panel" class="hidden">
        <div class="flex items-center justify-between mb-4">
          <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
            <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
          </button>
          <h2 id="calendar-month-year" class="text-xl font-bold text-gray-800"></h2>
          <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
            <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>

          <button id="sign-out-button" class="p-2 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 hidden" title="Sign out">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6A2.25 2.25 0 005.25 5.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/>
            </svg>
          </button>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
      </div>
    </div>

    <div id="edit-task-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
      <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-sm modal-content">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Edit Task</h2>
        <form id="edit-task-form" class="space-y-4">
          <div>
            <label for="edit-task-text" class="block text-sm font-medium text-gray-700">Task Name</label>
            <input type="text" id="edit-task-text" required class="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 animated-input">
          </div>
          <div>
            <label for="edit-task-date" class="block text-sm font-medium text-gray-700">Due Date</label>
            <input type="date" id="edit-task-date" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 animated-input">
          </div>
          <div class="flex justify-end space-x-3 mt-4">
            <button type="button" id="cancel-edit-task" class="px-4 py-2 text-gray-600 font-semibold rounded-full hover:bg-gray-200 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-300">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-full shadow-lg hover:bg-blue-600 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-400">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <div id="calendar-item-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
      <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-sm modal-content">
        <h2 id="calendar-item-title" class="text-2xl font-semibold mb-4 text-gray-800"></h2>
        <div class="flex justify-end space-x-3 mt-4">
          <button type="button" id="delete-calendar-item" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-full shadow-lg hover:bg-red-600 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-400">Delete</button>
          <button type="button" id="cancel-calendar-item" class="px-4 py-2 text-gray-600 font-semibold rounded-full hover:bg-gray-200 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-300">Cancel</button>

          <button id="sign-out-button" class="p-2 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 hidden" title="Sign out">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6A2.25 2.25 0 005.25 5.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div id="add-item-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
      <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-sm modal-content">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Add New Item</h2>
        <form id="add-item-form" class="space-y-4">
          <div>
            <label for="item-type" class="block text-sm font-medium text-gray-700">Type</label>
            <select id="item-type" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 animated-input">
              <option value="task">Task</option>
              <option value="event">Event</option>
            </select>
          </div>
          <div>
            <label for="item-text" class="block text-sm font-medium text-gray-700">Name</label>
            <input type="text" id="item-text" required class="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 animated-input">
          </div>
          <div id="event-time-picker" class="hidden">
            <label for="item-time" class="block text-sm font-medium text-gray-700">Time (Optional)</label>
            <input type="time" id="item-time" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 animated-input">
          </div>
          <div id="event-color-picker" class="hidden">
            <label class="block text-sm font-medium text-gray-700">Color</label>
            <div class="color-picker">
              <div class="color-option bg-red-500 selected" data-color="red-500"></div>
              <div class="color-option bg-blue-500" data-color="blue-500"></div>
              <div class="color-option bg-green-500" data-color="green-500"></div>
              <div class="color-option bg-yellow-500" data-color="yellow-500"></div>
              <div class="color-option bg-purple-500" data-color="purple-500"></div>
            </div>
          </div>

          <div class="flex justify-end space-x-3 mt-4">
            <button type="button" id="cancel-add-item" class="px-4 py-2 text-gray-600 font-semibold rounded-full hover:bg-gray-200 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-300">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-full shadow-lg hover:bg-blue-600 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-400">Add Item</button>
          </div>
        </form>
      </div>
    </div>

    <div id="settings-content" class="hidden bg-white p-6 rounded-3xl shadow-xl w-full max-w-sm modal-content">
      <div id="settings-header" class="drag-handle flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Settings</h2>
        <button id="close-settings" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 hover:scale-105 focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <div id="dropdowns-container" class="space-y-4">
        <!-- Style -->
        <div id="style-dropdown-container" class="settings-dropdown border-b border-gray-200 pb-2">
          <button class="dropdown-header w-full flex justify-between items-center py-2 text-gray-700 hover:text-gray-900 focus:outline-none">
            <h3 class="text-lg font-semibold">Style</h3>
            <svg class="h-6 w-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </button>
          <div class="dropdown-content">
            <div class="flex items-center justify-between">
              <span class="text-gray-600">Dark Mode</span>
              <label class="switch"><input type="checkbox" id="dark-mode-toggle"><span class="slider"></span></label>
            </div>
            <div class="flex items-center justify-between mt-4">
              <span class="text-gray-600">Particle Background</span>
              <label class="switch"><input type="checkbox" id="particles-toggle"><span class="slider"></span></label>
            </div>

            <div class="settings-dropdown mt-4 pl-4 border-t border-gray-200 pt-4">
              <button id="logo-dropdown-header" class="dropdown-header w-full flex justify-between items-center py-2 text-gray-700 hover:text-gray-900 focus:outline-none">
                <h4 class="text-base font-semibold">Logo</h4>
                <svg class="h-5 w-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div class="dropdown-content">
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">Floating Logo</span>
                  <label class="switch"><input type="checkbox" id="logo-toggle"><span class="slider"></span></label>
                </div>
                <div class="mt-4">
                  <input type="text" id="logo-url-input" placeholder="Enter image URL..." class="w-full p-2 text-sm border-2 border-gray-300 rounded-lg animated-input">
                  <button id="save-logo-url" class="w-full mt-2 px-4 py-2 rounded-full bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-all duration-200">Save Logo</button>
                </div>
              </div>
            </div>

            <div class="settings-dropdown mt-4 pl-4 border-t border-gray-200 pt-4">
              <button id="clock-dropdown-header" class="dropdown-header w-full flex justify-between items-center py-2 text-gray-700 hover:text-gray-900 focus:outline-none">
                <h4 class="text-base font-semibold">Clock</h4>
                <svg class="h-5 w-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div class="dropdown-content">
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">Show Clock</span>
                  <label class="switch"><input type="checkbox" id="clock-toggle"><span class="slider"></span></label>
                </div>
                <div class="mt-4">
                  <label for="clock-style-select" class="block text-sm font-medium text-gray-700">Clock Style</label>
                  <select id="clock-style-select" class="w-full p-2 text-sm border-2 border-gray-300 rounded-lg animated-input">
                    <option value="digital">Digital</option>
                    <option value="analog">Analog</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Features -->
        <div class="settings-dropdown border-b border-gray-200 pb-2">
          <button class="dropdown-header w-full flex justify-between items-center py-2 text-gray-700 hover:text-gray-900 focus:outline-none">
            <h3 class="text-lg font-semibold">AI Features</h3>
            <svg class="h-6 w-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </button>
          <div class="dropdown-content">
            <p class="text-sm text-gray-600 mb-3">Paste your Google AI Studio API key here to enable Gemini features.</p>
            <input type="text" id="api-key-input" placeholder="Paste your API key here..." class="w-full p-2 text-sm border-2 border-gray-300 rounded-xl animated-input">
            <button id="save-api-key" class="w-full mt-2 px-4 py-3 rounded-full bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-all duration-200">Save API Key</button>
          </div>
        </div>

        <!-- Export -->
        <div class="settings-dropdown border-b border-gray-200 pb-2">
          <button class="dropdown-header w-full flex justify-between items-center py-2 text-gray-700 hover:text-gray-900 focus:outline-none">
            <h3 class="text-lg font-semibold">Export Data</h3>
            <svg class="h-6 w-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </button>
          <div class="dropdown-content">
            <p class="text-sm text-gray-600 mb-3">Copy your data "seed" to save a backup or transfer to another device.</p>
            <textarea id="export-data" readonly class="w-full h-24 p-2 text-sm border-2 border-gray-300 rounded-xl bg-gray-50 focus:outline-none resize-none"></textarea>
            <div class="flex items-center justify-between mt-4">
              <span class="text-gray-600">Include API Key</span>
              <label class="switch"><input type="checkbox" id="include-api-key-toggle" checked><span class="slider"></span></label>
            </div>
            <button id="copy-export-data" class="w-full mt-2 px-4 py-3 rounded-full bg-green-500 text-white font-semibold hover:bg-green-600 transition-all duration-200">Copy to Clipboard</button>
          </div>
        </div>

        <!-- Import -->
        <div class="settings-dropdown border-b border-gray-200 pb-2">
          <button class="dropdown-header w-full flex justify-between items-center py-2 text-gray-700 hover:text-gray-900 focus:outline-none">
            <h3 class="text-lg font-semibold">Import Data</h3>
            <svg class="h-6 w-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </button>
          <div class="dropdown-content">
            <p class="text-sm text-gray-600 mb-3">Paste a "seed" phrase here to import your to-do list data.</p>
            <textarea id="import-data" placeholder="Paste your seed phrase here..." class="w-full h-24 p-2 text-sm border-2 border-gray-300 rounded-xl animated-input resize-none"></textarea>
            <button id="import-button" class="w-full mt-2 px-4 py-3 rounded-full bg-purple-500 text-white font-semibold hover:bg-purple-600 transition-all duration-200">Import Data</button>
          </div>
        </div>

        <!-- Danger -->
        <div class="settings-dropdown">
          <button class="dropdown-header w-full flex justify-between items-center py-2 text-gray-700 hover:text-gray-900 focus:outline-none">
            <h3 class="text-lg font-semibold">Danger Zone</h3>
            <svg class="h-6 w-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </button>
          <div class="dropdown-content">
            <button id="delete-all-data" class="w-full px-4 py-3 rounded-full bg-red-500 text-white font-semibold hover:bg-red-600 transition-all duration-200">Delete All Data</button>
            <button id="delete-account-button" class="w-full mt-3 px-4 py-3 rounded-full bg-red-600 text-white font-semibold hover:bg-red-700 transition-all duration-200">Delete Account</button>
          </div>
          <div class="mt-6 border-t pt-4">
            <button id="logout-button" class="w-full px-4 py-3 rounded-full bg-gray-800 text-white font-semibold hover:bg-gray-900 transition-all duration-200">Log out</button>
          </div>
        </div>
      </div>
    </div>

    <div id="gemini-content" class="hidden bg-white p-6 rounded-3xl shadow-XL flex flex-col modal-content" style="width: 500px; min-width: 300px; height: 500px; min-height: 300px;">
      <div id="gemini-header" class="drag-handle flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Gemini Chat</h2>
        <div class="flex items-center space-x-2">
          <span id="user-email" class="hidden md:inline text-sm text-gray-500 mr-2"></span>
          <button id="new-chat-btn" class="px-4 py-2 rounded-full text-sm font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors duration-200 focus:outline-none">New Chat</button>
          <button id="close-gemini" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 hover:scale-105 focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>

          <button id="sign-out-button" class="p-2 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 hidden" title="Sign out">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6A2.25 2.25 0 005.25 5.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/>
            </svg>
          </button>
        </div>
      </div>
      <div id="chat-history" class="chat-container flex-grow"></div>
      <form id="chat-form" class="flex items-center space-x-2">
        <input type="text" id="chat-input" placeholder="Ask me anything…" class="animated-input flex-grow p-3 border-2 border-gray-300 rounded-xl focus:outline-none transition-colors duration-200">
        <button type="submit" id="chat-send-button" class="bg-blue-500 text-white p-3 rounded-xl shadow-lg hover:bg-blue-600 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/></svg>
        </button>
      </form>
      <div class="resize-handle"></div>
    </div>

    <div id="custom-alert-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="bg-white p-6 rounded-3xl shadow-XL w-full max-w-sm modal-content">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">API Key Required</h2>
        <p id="custom-alert-message" class="text-gray-600 mb-6">Please go to <strong>Settings &gt; AI Features</strong> to import your Google AI Studio API key to enable AI features.</p>
        <div class="flex justify-end">
          <button id="close-alert-button" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-all duration-200 focus:outline-none">OK</button>

          <button id="sign-out-button" class="p-2 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 hidden" title="Sign out">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6A2.25 2.25 0 005.25 5.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const STORAGE_KEY = `todo-app-${appId}`;
      const API_KEY_STORAGE_KEY = 'gemini-api-key';
      const THEME_STORAGE_KEY = 'theme';
      const PARTICLES_STORAGE_KEY = 'particles-enabled';
      const LOGO_ENABLED_STORAGE_KEY = 'logo-enabled';
      const LOGO_URL_STORAGE_KEY = 'logo-url';
      const EVENTS_STORAGE_KEY = 'events-app';
      const CLOCK_ENABLED_STORAGE_KEY = 'clock-enabled';
      const CLOCK_STYLE_STORAGE_KEY = 'clock-style';
      const CLOCK_POSITION_STORAGE_KEY = 'clock-position';

      // === Firebase setup ===
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
      import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA4y0PSIfgooaUIMg5VLbPgYtqx9TVwbKw",
        authDomain: "todo-c98c2.firebaseapp.com",
        projectId: "todo-c98c2",
        storageBucket: "todo-c98c2.firebasestorage.app",
        messagingSenderId: "864123807495",
        appId: "1:864123807495:web:bd8853f3f5349cd7c347a2",
        measurementId: "G-0WN4LR9LJ2"
      };

      const fbApp = initializeApp(firebaseConfig);
      try { getAnalytics(fbApp); } catch (e) { /* analytics optional */ }
      const auth = getAuth(fbApp);
      const db = getFirestore(fbApp);

      // Firestore doc for this user
      let currentUser = null;
      let userDocRef = null;
      let unsubscribeUserDoc = null;

      // Settings helpers (mirror local settings into Firestore)
      const DEFAULT_SETTINGS = {
        [THEME_STORAGE_KEY]: 'light',
        [PARTICLES_STORAGE_KEY]: 'false',
        [LOGO_ENABLED_STORAGE_KEY]: 'false',
        [LOGO_URL_STORAGE_KEY]: '',
        [CLOCK_ENABLED_STORAGE_KEY]: 'false',
        [CLOCK_STYLE_STORAGE_KEY]: 'digital',
        [CLOCK_POSITION_STORAGE_KEY]: JSON.stringify({top:'',left:''})
      };

      function collectSettingsFromLocal() {
        return {
          theme: localStorage.getItem(THEME_STORAGE_KEY) || DEFAULT_SETTINGS[THEME_STORAGE_KEY],
          particlesEnabled: localStorage.getItem(PARTICLES_STORAGE_KEY) === 'true',
          logoEnabled: localStorage.getItem(LOGO_ENABLED_STORAGE_KEY) === 'true',
          logoUrl: localStorage.getItem(LOGO_URL_STORAGE_KEY) || '',
          clockEnabled: localStorage.getItem(CLOCK_ENABLED_STORAGE_KEY) === 'true',
          clockStyle: localStorage.getItem(CLOCK_STYLE_STORAGE_KEY) || 'digital',
          clockPosition: (()=>{try{return JSON.parse(localStorage.getItem(CLOCK_POSITION_STORAGE_KEY)||'{}');}catch(e){return {};} })()
        };
      }

      function applySettingsToUI(settingsData){
        if (settingsData.theme) localStorage.setItem(THEME_STORAGE_KEY, settingsData.theme);
        localStorage.setItem(PARTICLES_STORAGE_KEY, settingsData.particlesEnabled ? 'true' : 'false');
        localStorage.setItem(LOGO_ENABLED_STORAGE_KEY, settingsData.logoEnabled ? 'true' : 'false');
        localStorage.setItem(LOGO_URL_STORAGE_KEY, settingsData.logoUrl || '');
        localStorage.setItem(CLOCK_ENABLED_STORAGE_KEY, settingsData.clockEnabled ? 'true' : 'false');
        if (settingsData.clockStyle) localStorage.setItem(CLOCK_STYLE_STORAGE_KEY, settingsData.clockStyle);
        if (settingsData.clockPosition) localStorage.setItem(CLOCK_POSITION_STORAGE_KEY, JSON.stringify(settingsData.clockPosition));

        loadTheme();
        loadParticlesState();
        updateLogo();
        loadClockState();
      }

      let saveTimer = null;
      async function saveAllDataFirestore() {
        if (!currentUser || !userDocRef) return;
        const settingsData = collectSettingsFromLocal();
        try {
          await setDoc(userDocRef, {
            tasks, events,
            settings: settingsData,
            updatedAt: serverTimestamp()
          }, { merge: true });
        } catch(e){ console.error('saveAllDataFirestore error:', e); }
      }
      function debounceSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(saveAllDataFirestore, 400); }

      const mainContainer = document.getElementById('main-container');

      const taskForm = document.getElementById('task-form');
      const taskInput = document.getElementById('task-input');
      const taskList = document.getElementById('task-list');
      const completedTaskList = document.getElementById('completed-task-list');
      const completeTasksContainer = document.getElementById('complete-tasks');

      const editTaskModal = document.getElementById('edit-task-modal');
      const editTaskForm = document.getElementById('edit-task-form');
      const editTaskText = document.getElementById('edit-task-text');
      const editTaskDate = document.getElementById('edit-task-date');
      const cancelEditTaskButton = document.getElementById('cancel-edit-task');

      const calendarItemModal = document.getElementById('calendar-item-modal');
      const calendarItemTitle = document.getElementById('calendar-item-title');
      const deleteCalendarItemButton = document.getElementById('delete-calendar-item');
      const cancelCalendarItemButton = document.getElementById('cancel-calendar-item');

      const settingsButton = document.getElementById('settings-button');
      const settingsContent = document.getElementById('settings-content');
      const closeSettingsButton = document.getElementById('close-settings');
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      const particlesToggle = document.getElementById('particles-toggle');
      const deleteAllDataButton = document.getElementById('delete-all-data');
      const exportDataTextarea = document.getElementById('export-data');
      const copyExportDataButton = document.getElementById('copy-export-data');
      const importDataTextarea = document.getElementById('import-data');
      const importButton = document.getElementById('import-button');
      const settingsHeader = document.getElementById('settings-header');
      const includeApiKeyToggle = document.getElementById('include-api-key-toggle');
      const floatingLogo = document.getElementById('floating-logo');
      const logoToggle = document.getElementById('logo-toggle');
      const logoUrlInput = document.getElementById('logo-url-input');
      const saveLogoUrlButton = document.getElementById('save-logo-url');
      const addItemModal = document.getElementById('add-item-modal');
      const addItemForm = document.getElementById('add-item-form');
      const itemTypeSelect = document.getElementById('item-type');
      const itemTextInput = document.getElementById('item-text');
      const itemTimeInput = document.getElementById('item-time');
      const eventTimePicker = document.getElementById('event-time-picker');
      const eventColorPicker = document.getElementById('event-color-picker');
      const cancelAddItemButton = document.getElementById('cancel-add-item');

      const liveClock = document.getElementById('live-clock');
      const clockDragHandle = document.getElementById('clock-drag-handle');
      const digitalClock = document.getElementById('digital-clock');
      const analogClock = document.getElementById('analog-clock');
      const hourHand = document.getElementById('hour-hand');
      const minuteHand = document.getElementById('minute-hand');
      const secondHand = document.getElementById('second-hand');
      const clockToggle = document.getElementById('clock-toggle');
      const clockStyleSelect = document.getElementById('clock-style-select');

      // Gemini chat elements
      const geminiButton = document.getElementById('gemini-button');
      const geminiContent = document.getElementById('gemini-content');
      const closeGeminiButton = document.getElementById('close-gemini');
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      const chatHistory = document.getElementById('chat-history');
      const geminiHeader = document.getElementById('gemini-header');
      const chatSendButton = document.getElementById('chat-send-button');
      const newChatButton = document.getElementById('new-chat-btn');
      const resizeHandle = document.querySelector('.resize-handle');

      // API Key + Alert
      const apiKeyInput = document.getElementById('api-key-input');
      const saveApiKeyButton = document.getElementById('save-api-key');
      const customAlertModal = document.getElementById('custom-alert-modal');
      const customAlertMessage = document.getElementById('custom-alert-message');
      const closeAlertButton = document.getElementById('close-alert-button');

      // Tabs + Calendar
      const todoTabButton = document.getElementById('todo-tab-button');
      const calendarTabButton = document.getElementById('calendar-tab-button');
      const todoPanel = document.getElementById('todo-panel');
      const calendarPanel = document.getElementById('calendar-panel');
      const calendarMonthYear = document.getElementById('calendar-month-year');
      const calendarGrid = document.getElementById('calendar-grid');
      const prevMonthBtn = document.getElementById('prev-month-btn');
      const nextMonthBtn = document.getElementById('next-month-btn');

      // Particles
      const canvas = document.getElementById('particles-canvas');
      const ctx = canvas.getContext('2d');
      let particles = [];
      let particlesEnabled = false;
      let animationFrameId = null;

      // Floating logo
      let logoEnabled = false;
      let logoUrl = '';
      let logoX = 0;
      let logoY = 0;
      let logoSpeedX = 2;
      let logoSpeedY = 2;

      let tasks = [];
      let events = [];
      let currentEditIndex = -1;
      let chatConversation = [];
      let originalGeminiState = null;
      let currentAddItemDate = null;
      let itemToDelete = null;
      let currentApiKey = null;

      // Calendar state
      let calendarDate = new Date();

      function saveAllData(){ debounceSave(); }
      function saveTasks(){ debounceSave(); }
      function saveEvents(){ debounceSave(); }

      function loadAllData() { loadTasks(); loadEvents(); renderApp(); }
      function loadTasks(){ sortTasksByDueDate(); }
      function loadEvents(){}

      function sortTasksByDueDate() {
        tasks.sort((a, b) => {
          const dateA = a.dueDate ? new Date(a.dueDate) : null;
          const dateB = b.dueDate ? new Date(b.dueDate) : null;
          if (!dateA && !dateB) return 0;
          if (!dateA) return 1;
          if (!dateB) return -1;
          return dateA - dateB;
        });
      }

      function renderApp() { renderTasks(); renderCalendar(); }

      async function brainstormSubtasks(taskText, brainstormButton) {
        const apiKey = currentApiKey;
        if (!apiKey) { showCustomAlert("No API key found. Please save your key in Settings to use this feature."); return; }

        const systemPrompt = "You are a world-class project manager. Your goal is to take a high-level task and break it down into 5 to 7 smaller, actionable subtasks. Do not provide any introduction or conclusion, just the JSON array of strings.";
        const userQuery = `Break down the task "${taskText}" into a list of actionable subtasks.`;

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = {
          contents: [{ parts: [{ text: userQuery }]}],
          systemInstruction: { parts: [{ text: systemPrompt }]},
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: { type: "ARRAY", items: { type: "STRING" } }
          }
        };

        brainstormButton.innerHTML = `<span class="spinner"></span>`;
        brainstormButton.disabled = true;

        try {
          const response = await fetch(apiUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const result = await response.json();
          if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
            const parsedSubtasks = JSON.parse(result.candidates[0].content.parts[0].text);
            return parsedSubtasks.map(text => ({ text, completed:false, dueDate:null }));
          }
          return null;
        } catch (err) {
          console.error('Gemini error:', err);
          showCustomAlert("Failed to brainstorm subtasks. Please check your API key and try again.");
          return null;
        } finally {
          brainstormButton.innerHTML = `Brainstorm`;
          brainstormButton.disabled = false;
        }
      }

      async function handleBrainstormClick(index, button) {
        const originalTask = tasks[index];
        const subtasks = await brainstormSubtasks(originalTask.text, button);
        if (subtasks?.length) {
          tasks[index].subtasks = subtasks;
          tasks[index].isExpanded = true;
          saveTasks(); renderApp();
        }
      }

      function toggleSubtasks(index) {
        tasks[index].isExpanded = !tasks[index].isExpanded;
        saveTasks(); renderApp();
      }

      function addSubtask(parentIndex, subtaskText) {
        const parentTask = tasks[parentIndex];
        if (!parentTask) return;
        if (!parentTask.subtasks) parentTask.subtasks = [];
        parentTask.subtasks.push({ text: subtaskText, completed:false, dueDate:null });
        parentTask.isExpanded = true;
        saveTasks(); renderApp();
      }

      function deleteSubtask(parentIndex, subtaskIndex) {
        const parentTask = tasks[parentIndex];
        if (!parentTask?.subtasks) return;
        parentTask.subtasks.splice(subtaskIndex, 1);
        if (!parentTask.subtasks.length) { delete parentTask.subtasks; parentTask.isExpanded = false; }
        saveTasks(); renderApp();
      }

      function renderTasks() {
        taskList.innerHTML = '';
        completedTaskList.innerHTML = '';
        const hasApiKey = !!currentApiKey;
        let hasCompletedTasks = false;

        tasks.forEach((task, index) => {
          const li = document.createElement('li');
          li.className = `p-4 bg-gray-50 rounded-2xl shadow-sm hover:shadow-md transition-shadow duration-200 animate-slideIn`;

          const row = document.createElement('div');
          row.className = 'flex flex-col md:flex-row items-start md:items-center w-full space-x-3';

          const expandButton = document.createElement('button');
          expandButton.className = `flex-shrink-0 w-6 h-6 text-gray-500 hover:text-gray-700 focus:outline-none`;
          expandButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 transform ${task.isExpanded ? 'rotate-90' : ''}"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/></svg>`;
          expandButton.addEventListener('click', () => toggleSubtasks(index));
          row.appendChild(expandButton);

          const content = document.createElement('div');
          content.className = 'flex items-center flex-grow';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = task.completed;
          checkbox.className = 'form-checkbox h-5 w-5 text-blue-600 rounded-md focus:ring-blue-500 transition-colors duration-200 mr-3 cursor-pointer';
          checkbox.addEventListener('change', () => toggleComplete(index));

          const taskText = document.createElement('span');
          taskText.textContent = task.text;
          taskText.className = `task-list-item-text text-lg font-medium text-gray-800 ${task.completed ? 'completed' : ''}`;

          content.appendChild(checkbox);
          content.appendChild(taskText);
          row.appendChild(content);

          const right = document.createElement('div');
          right.className = 'flex items-center w-full md:w-auto md:ml-auto space-x-3 mt-2 md:mt-0 justify-end';

          const dueDateSpan = document.createElement('span');
          if (task.dueDate) {
            const date = new Date(task.dueDate);
            const adjusted = new Date(date.getTime() + date.getTimezoneOffset()*60000);
            dueDateSpan.textContent = `Due: ${adjusted.toLocaleDateString()}`;
            dueDateSpan.className = 'text-sm text-gray-500 px-3 py-1 bg-gray-200 rounded-full font-medium';
          }

          if (hasApiKey) {
            const brainstormButton = document.createElement('button');
            brainstormButton.className = 'p-2 text-sm bg-purple-500 text-white rounded-full hover:bg-purple-600 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-400';
            brainstormButton.textContent = 'Brainstorm';
            brainstormButton.addEventListener('click', () => handleBrainstormClick(index, brainstormButton));
            right.appendChild(brainstormButton);
          }

          const editButton = document.createElement('button');
          editButton.className = 'px-3 py-2 bg-yellow-400 text-white rounded-lg shadow-sm hover:bg-yellow-500 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-yellow-300';
          editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"/></svg>`;
          editButton.addEventListener('click', () => openEditTaskModal(index));
          right.appendChild(editButton);

          const deleteButton = document.createElement('button');
          deleteButton.className = 'px-3 py-2 bg-red-500 text-white rounded-lg shadow-sm hover:bg-red-600 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-400';
          deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd"/></svg>`;
          deleteButton.addEventListener('click', () => deleteTask(index, li));

          right.appendChild(dueDateSpan);
          right.appendChild(deleteButton);

          row.appendChild(right);
          li.appendChild(row);

          // Subtasks
          const subtasksContainer = document.createElement('ul');
          subtasksContainer.className = `subtasks-container space-y-2`;
          if (task.isExpanded) subtasksContainer.classList.add('expanded');

          if (task.subtasks) {
            task.subtasks.forEach((subtask, sIdx) => {
              const subLi = document.createElement('li');
              subLi.className = 'flex items-center space-x-2';
              const subCheck = document.createElement('input');
              subCheck.type = 'checkbox';
              subCheck.checked = subtask.completed;
              subCheck.className = 'form-checkbox h-4 w-4 text-blue-600 rounded-md focus:ring-blue-500 transition-colors duration-200 cursor-pointer';
              subCheck.addEventListener('change', () => toggleSubtaskComplete(task, subtask));

              const subText = document.createElement('span');
              subText.textContent = subtask.text;
              subText.className = `text-md text-gray-700 flex-grow ${subtask.completed ? 'completed' : ''}`;

              const subDel = document.createElement('button');
              subDel.className = 'flex-shrink-0 text-red-400 hover:text-red-600';
              subDel.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd"/></svg>`;
              subDel.addEventListener('click', () => deleteSubtask(index, sIdx));

              subLi.appendChild(subCheck);
              subLi.appendChild(subText);
              subLi.appendChild(subDel);
              subtasksContainer.appendChild(subLi);
            });
          }

          // Add subtask form
          const addSubtaskForm = document.createElement('form');
          addSubtaskForm.className = 'flex items-center space-x-2 mt-2';
          const addSubtaskInput = document.createElement('input');
          addSubtaskInput.type = 'text';
          addSubtaskInput.placeholder = 'Add a new subtask…';
          addSubtaskInput.className = 'animated-input flex-grow p-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none transition-colors duration-200';
          const addSubtaskButton = document.createElement('button');
          addSubtaskButton.type = 'submit';
          addSubtaskButton.className = 'p-2 bg-blue-500 text-white rounded-xl shadow-lg hover:bg-blue-600 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-400';
          addSubtaskButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>`;

          const brainstormSubtaskButton = document.createElement('button');
          brainstormSubtaskButton.type = 'button';
          brainstormSubtaskButton.className = 'p-2 bg-purple-500 text-white rounded-xl shadow-lg hover:bg-purple-600 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-400';
          brainstormSubtaskButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2a10 10 0 100 20 10 10 0 000-20zM9.5 13.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM14.5 13.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM12 18a4 4 0 100-8 4 4 0 000 8z"/></svg>`;
          brainstormSubtaskButton.addEventListener('click', () => handleBrainstormClick(index, brainstormSubtaskButton));

          addSubtaskForm.appendChild(addSubtaskInput);
          addSubtaskForm.appendChild(addSubtaskButton);
          if (hasApiKey) addSubtaskForm.appendChild(brainstormSubtaskButton);

          addSubtaskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = addSubtaskInput.value.trim();
            if (text) { addSubtask(index, text); addSubtaskInput.value = ''; }
          });

          if (task.completed) {
            completedTaskList.appendChild(li);
            hasCompletedTasks = true;
          } else {
            subtasksContainer.appendChild(addSubtaskForm);
            li.appendChild(subtasksContainer);
            taskList.appendChild(li);
          }
        });

        completeTasksContainer.classList.toggle('hidden', !hasCompletedTasks);
      }

      function renderCalendar() {
        const month = calendarDate.getMonth();
        const year = calendarDate.getFullYear();
        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        calendarMonthYear.textContent = `${monthNames[month]} ${year}`;
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        calendarGrid.innerHTML = '';

        ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(day => {
          const headerCell = document.createElement('div');
          headerCell.className = 'calendar-header-cell';
          headerCell.textContent = day;
          calendarGrid.appendChild(headerCell);
        });

        const tasksByDate = {};
        tasks.forEach((task, index) => {
          if (task.dueDate) {
            if (!tasksByDate[task.dueDate]) tasksByDate[task.dueDate] = [];
            tasksByDate[task.dueDate].push({ ...task, originalIndex: index });
          }
        });

        const eventsByDate = {};
        events.forEach((event, index) => {
          if (event.date) {
            if (!eventsByDate[event.date]) eventsByDate[event.date] = [];
            eventsByDate[event.date].push({ ...event, originalIndex: index });
          }
        });

        for (let i = 0; i < firstDayOfMonth; i++) {
          const blank = document.createElement('div');
          blank.className = 'calendar-day-cell is-other-month';
          calendarGrid.appendChild(blank);
        }

        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'calendar-day-cell';

          const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
          dayCell.dataset.date = dateStr;
          dayCell.addEventListener('click', () => openAddItemModal(dateStr));

          if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
            dayCell.classList.add('is-today');
          }

          const dayNumber = document.createElement('div');
          dayNumber.className = 'day-number';
          dayNumber.textContent = day;
          dayCell.appendChild(dayNumber);

          if (tasksByDate[dateStr]) {
            tasksByDate[dateStr].forEach(task => {
              const taskEl = document.createElement('div');
              taskEl.className = 'calendar-task';
              if (task.completed) taskEl.classList.add('completed');
              taskEl.textContent = task.text;
              taskEl.title = task.text;
              taskEl.addEventListener('click', (e) => { e.stopPropagation(); openCalendarItemModal('task', task.originalIndex); });
              dayCell.appendChild(taskEl);
            });
          }

          if (eventsByDate[dateStr]) {
            eventsByDate[dateStr].forEach(event => {
              const eventEl = document.createElement('div');
              eventEl.className = `calendar-event bg-${event.color}`;
              eventEl.textContent = event.time ? `${formatTime12Hour(event.time)} ${event.text}` : event.text;
              eventEl.title = event.text;
              eventEl.addEventListener('click', (e) => { e.stopPropagation(); openCalendarItemModal('event', event.originalIndex); });
              dayCell.appendChild(eventEl);
            });
          }

          calendarGrid.appendChild(dayCell);
        }
      }

      function formatTime12Hour(time) {
        if (!time) return '';
        let [hours, minutes] = time.split(':');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12; hours = hours ? hours : 12;
        return `${hours}:${minutes} ${ampm}`;
      }

      function openCalendarItemModal(type, index) {
        itemToDelete = { type, index };
        const item = type === 'task' ? tasks[index] : events[index];
        calendarItemTitle.textContent = item.text;
        calendarItemModal.classList.remove('hidden');
      }
      function closeCalendarItemModal() { calendarItemModal.classList.add('hidden'); itemToDelete = null; }

      deleteCalendarItemButton.addEventListener('click', () => {
        if (!itemToDelete) return;
        if (itemToDelete.type === 'task') { tasks.splice(itemToDelete.index, 1); saveTasks(); }
        else { events.splice(itemToDelete.index, 1); saveEvents(); }
        renderApp(); closeCalendarItemModal();
      });
      cancelCalendarItemButton.addEventListener('click', closeCalendarItemModal);

      function toggleSubtaskComplete(parentTask, subtask) { subtask.completed = !subtask.completed; saveTasks(); renderApp(); }

      taskForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = taskInput.value.trim();
        if (!text) return;
        tasks.push({ text, completed:false, dueDate:null, subtasks:[], isExpanded:true });
        taskInput.value = '';
        sortTasksByDueDate(); saveTasks(); renderApp();
      });

      function openAddItemModal(dateStr) { currentAddItemDate = dateStr; addItemModal.classList.remove('hidden'); }
      function closeAddItemModal() {
        addItemModal.classList.add('hidden');
        currentAddItemDate = null; addItemForm.reset();
        eventColorPicker.classList.add('hidden'); eventTimePicker.classList.add('hidden');
      }

      itemTypeSelect.addEventListener('change', () => {
        if (itemTypeSelect.value === 'event') { eventColorPicker.classList.remove('hidden'); eventTimePicker.classList.remove('hidden'); }
        else { eventColorPicker.classList.add('hidden'); eventTimePicker.classList.add('hidden'); }
      });

      eventColorPicker.addEventListener('click', (e) => {
        if (!e.target.classList.contains('color-option')) return;
        document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
        e.target.classList.add('selected');
      });

      addItemForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const itemText = itemTextInput.value.trim();
        if (!itemText || !currentAddItemDate) return;

        if (itemTypeSelect.value === 'task') {
          tasks.push({ text:itemText, completed:false, dueDate: currentAddItemDate, subtasks:[], isExpanded:false });
          sortTasksByDueDate(); saveTasks();
        } else {
          const selectedColor = document.querySelector('.color-option.selected').dataset.color;
          events.push({ text:itemText, date: currentAddItemDate, time: itemTimeInput.value || null, color: selectedColor });
          saveEvents();
        }
        renderApp(); closeAddItemModal();
      });

      function openEditTaskModal(index) { currentEditIndex = index; const t = tasks[index]; editTaskText.value = t.text; editTaskDate.value = t.dueDate || ''; editTaskModal.classList.remove('hidden'); }
      function closeEditTaskModal() { editTaskModal.classList.add('hidden'); currentEditIndex = -1; }
      editTaskForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (currentEditIndex < 0) return;
        tasks[currentEditIndex].text = editTaskText.value;
        tasks[currentEditIndex].dueDate = editTaskDate.value;
        sortTasksByDueDate(); saveTasks(); renderApp(); closeEditTaskModal();
      });
      cancelEditTaskButton.addEventListener('click', closeEditTaskModal);
      cancelAddItemButton.addEventListener('click', closeAddItemModal);

      function toggleComplete(index) { tasks[index].completed = !tasks[index].completed; saveTasks(); renderApp(); }
      function deleteTask(index, el) {
        el.style.animation = 'fadeOut .3s ease-in-out';
        el.addEventListener('animationend', () => { tasks.splice(index, 1); saveTasks(); renderApp(); }, { once:true });
      }

      // Settings modal
      let isDraggingSettings = false; let offsetSettings = { x:0, y:0 };
      function openSettingsModal() {
        settingsContent.classList.remove('hidden');
        const exported = { tasks, events, apiKey: includeApiKeyToggle.checked ? currentApiKey : undefined };
        exportDataTextarea.value = btoa(JSON.stringify(exported));
      }
      function closeSettingsModal() { settingsContent.classList.add('hidden'); }
      settingsButton.addEventListener('click', openSettingsModal);
      closeSettingsButton.addEventListener('click', closeSettingsModal);

      settingsHeader.addEventListener('mousedown', (e) => { isDraggingSettings = true; offsetSettings.x = e.clientX - settingsContent.offsetLeft; offsetSettings.y = e.clientY - settingsContent.offsetTop; });
      document.addEventListener('mousemove', (e) => { if (isDraggingSettings) { settingsContent.style.left = (e.clientX - offsetSettings.x) + 'px'; settingsContent.style.top = (e.clientY - offsetSettings.y) + 'px'; }});
      document.addEventListener('mouseup', () => { isDraggingSettings = false; });

      const dropdownHeaders = document.querySelectorAll('.dropdown-header');
      dropdownHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const content = header.nextElementSibling;
          const icon = header.querySelector('svg');
          const isNested = header.parentElement.classList.contains('settings-dropdown') && header.parentElement.parentElement.classList.contains('dropdown-content');
          const isStyleOpen = document.getElementById('style-dropdown-container').querySelector('.dropdown-content').classList.contains('open');
          if (isNested && !isStyleOpen) return;
          if (content.classList.contains('open')) { content.classList.remove('open'); icon.classList.remove('rotate-180'); }
          else {
            if (!isNested) {
              document.querySelectorAll('.dropdown-content.open').forEach(open => { if (!open.contains(header)) { open.classList.remove('open'); open.previousElementSibling.querySelector('svg').classList.remove('rotate-180'); }});
            }
            content.classList.add('open'); icon.classList.add('rotate-180');
          }
        });
      });

      // Dark mode toggle
      function loadTheme() {
        const stored = localStorage.getItem(THEME_STORAGE_KEY);
        if (stored === 'dark') { document.documentElement.classList.add('dark'); darkModeToggle.checked = true; }
        else { document.documentElement.classList.remove('dark'); darkModeToggle.checked = false; }
      }
      darkModeToggle.addEventListener('change', () => {
        if (darkModeToggle.checked) { document.documentElement.classList.add('dark'); localStorage.setItem(THEME_STORAGE_KEY,'dark'); }
        else { document.documentElement.classList.remove('dark'); localStorage.setItem(THEME_STORAGE_KEY,'light'); }
      });

      // Floating logo
      function loadLogoState() {
        logoEnabled = localStorage.getItem(LOGO_ENABLED_STORAGE_KEY) === 'true';
        logoUrl = localStorage.getItem(LOGO_URL_STORAGE_KEY) || '';
        logoToggle.checked = logoEnabled; logoUrlInput.value = logoUrl;
        if (logoEnabled && logoUrl) {
          floatingLogo.src = logoUrl; floatingLogo.classList.remove('hidden');
          logoX = Math.random() * (window.innerWidth - floatingLogo.offsetWidth);
          logoY = Math.random() * (window.innerHeight - floatingLogo.offsetHeight);
        } else { floatingLogo.classList.add('hidden'); }
      }
      function updateLogo() {
        logoEnabled = localStorage.getItem(LOGO_ENABLED_STORAGE_KEY) === 'true';
        logoUrl = localStorage.getItem(LOGO_URL_STORAGE_KEY) || '';
        logoToggle.checked = logoEnabled; logoUrlInput.value = logoUrl;
        if (logoEnabled && logoUrl) { floatingLogo.src = logoUrl; floatingLogo.classList.remove('hidden'); if (!animationFrameId) animateBackground(); }
        else { floatingLogo.classList.add('hidden'); }
      }
      logoToggle.addEventListener('change', () => { localStorage.setItem(LOGO_ENABLED_STORAGE_KEY, logoToggle.checked); updateLogo(); });
      saveLogoUrlButton.addEventListener('click', () => { localStorage.setItem(LOGO_URL_STORAGE_KEY, logoUrlInput.value.trim()); updateLogo(); });

      function animateBackground() {
        if (particlesEnabled) {
          ctx.clearRect(0,0,canvas.width,canvas.height);
          for (let i=0;i<particles.length;i++){ particles[i].update(); particles[i].draw(); }
          connectParticles();
        }
        if (logoEnabled && floatingLogo.src) {
          logoX += logoSpeedX; logoY += logoSpeedY;
          const w = floatingLogo.offsetWidth, h = floatingLogo.offsetHeight;
          if (logoX + w > window.innerWidth || logoX < 0) logoSpeedX *= -1;
          if (logoY + h > window.innerHeight || logoY < 0) logoSpeedY *= -1;
          floatingLogo.style.left = logoX + 'px'; floatingLogo.style.top = logoY + 'px';
        }
        animationFrameId = requestAnimationFrame(animateBackground);
      }

      // Particles
      class Particle {
        constructor(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.size=Math.random()*2+1; this.speedX=Math.random()*1-.5; this.speedY=Math.random()*1-.5; }
        update(){ this.x+=this.speedX; this.y+=this.speedY; if (this.x>canvas.width||this.x<0) this.speedX*=-1; if (this.y>canvas.height||this.y<0) this.speedY*=-1; }
        draw(){ ctx.fillStyle='rgba(150,150,150,.5)'; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); }
      }
      function createParticles(){ particles=[]; const n=(canvas.width*canvas.height)/9000; for(let i=0;i<n;i++) particles.push(new Particle()); }
      function connectParticles(){
        let o=1;
        for(let a=0;a<particles.length;a++){
          for(let b=a;b<particles.length;b++){
            const d=Math.hypot(particles[a].x-particles[b].x, particles[a].y-particles[b].y);
            if (d<100){ o=1-(d/100); ctx.strokeStyle=`rgba(150,150,150,${o})`; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(particles[a].x,particles[a].y); ctx.lineTo(particles[b].x,particles[b].y); ctx.stroke(); }
          }
        }
      }
      function resizeCanvas(){ const w=window.innerWidth,h=window.innerHeight; if (canvas.width!==w||canvas.height!==h){ canvas.width=w; canvas.height=h; if (particlesEnabled) createParticles(); } }
      function loadParticlesState(){
        particlesEnabled = localStorage.getItem(PARTICLES_STORAGE_KEY) === 'true';
        particlesToggle.checked = particlesEnabled;
        if (particlesEnabled){ resizeCanvas(); createParticles(); } else { ctx.clearRect(0,0,canvas.width,canvas.height); }
      }
      particlesToggle.addEventListener('change', () => {
        particlesEnabled = particlesToggle.checked; localStorage.setItem(PARTICLES_STORAGE_KEY, particlesEnabled);
        if (particlesEnabled){ resizeCanvas(); createParticles(); } else { ctx.clearRect(0,0,canvas.width,canvas.height); }
      });
      window.addEventListener('resize', () => {
        resizeCanvas();
        if (logoEnabled && floatingLogo.src) {
          logoX = Math.random() * (window.innerWidth - floatingLogo.offsetWidth);
          logoY = Math.random() * (window.innerHeight - floatingLogo.offsetHeight);
        }
      });

      // Save API Key via Firestore
      saveApiKeyButton.addEventListener('click', async () => {
        const newKey = apiKeyInput.value.trim();
        if (!newKey) { showCustomAlert("Please enter a valid API key."); return; }
        if (!currentUser) { showCustomAlert("Please sign in first to save your API key securely."); return; }
        try {
          await setDoc(userDocRef, { apiKey: newKey }, { merge: true });
          currentApiKey = newKey;
          showCustomAlert("API Key saved securely to your account.");
          renderApp();
        } catch (e) { console.error('Failed to save API key:', e); showCustomAlert("Could not save API key. Please try again."); }
      });

      // Delete All Data
      deleteAllDataButton.addEventListener('click', async () => {
        try { tasks = []; events = []; await saveAllDataFirestore(); renderApp(); closeSettingsModal(); }
        catch(e){ console.error('Failed to delete data:', e); showCustomAlert('Failed to delete your data. Please try again.'); }
      });

      // Export
      copyExportDataButton.addEventListener('click', () => {
        const exported = { tasks, events, apiKey: includeApiKeyToggle.checked ? currentApiKey : undefined };
        const dataToCopy = btoa(JSON.stringify(exported));
        exportDataTextarea.value = dataToCopy;
        exportDataTextarea.select();
        document.execCommand('copy');
      });

      // Import
      importButton.addEventListener('click', async () => {
        try {
          const importedData = JSON.parse(atob(importDataTextarea.value));
          if (Array.isArray(importedData)) {
            tasks = importedData; events = [];
            try { await setDoc(userDocRef, { apiKey: null }, { merge: true }); currentApiKey = null; } catch(e){}
            showCustomAlert("Data imported successfully! No API Key or events were found in the data.");
          } else if (typeof importedData === 'object' && importedData.tasks) {
            tasks = importedData.tasks || []; events = importedData.events || [];
            if (importedData.apiKey) { try { await setDoc(userDocRef, { apiKey: importedData.apiKey }, { merge: true }); currentApiKey = importedData.apiKey; } catch(e){} showCustomAlert("Data imported successfully, and API Key applied!"); }
            else { try { await setDoc(userDocRef, { apiKey: null }, { merge: true }); currentApiKey = null; } catch(e){} showCustomAlert("Data imported successfully! No API Key was found in the data."); }
          } else { throw new Error('Invalid data format.'); }
          sortTasksByDueDate(); saveAllData(); renderApp(); closeSettingsModal();
        } catch(e){ showCustomAlert('Invalid or corrupted backup file.'); console.error(e); }
      });

      // Gemini Chat
      let isDraggingGemini = false;
      let offsetGemini = { x:0, y:0 };

      function openGeminiModal() {
        if (!currentApiKey) { showCustomAlert("Please go to <strong>Settings &gt; AI Features</strong> to import your API key to enable this feature."); return; }
        geminiContent.classList.remove('hidden');
      }
      function closeGeminiModal() { geminiContent.classList.add('hidden'); }
      geminiButton.addEventListener('click', openGeminiModal);
      closeGeminiButton.addEventListener('click', closeGeminiModal);

      // Drag Gemini
      geminiHeader.addEventListener('mousedown', (e) => {
        if (e.target.closest('#new-chat-btn') || e.target.closest('#close-gemini')) return;
        isDraggingGemini = true; offsetGemini.x = e.clientX - geminiContent.offsetLeft; offsetGemini.y = e.clientY - geminiContent.offsetTop;
      });
      document.addEventListener('mousemove', (e) => { if (isDraggingGemini){ geminiContent.style.left = (e.clientX - offsetGemini.x) + 'px'; geminiContent.style.top = (e.clientY - offsetGemini.y) + 'px'; }});
      document.addEventListener('mouseup', () => { isDraggingGemini = false; isResizing = false; });

      // Resize Gemini
      let isResizing = false; let initialX, initialY, initialWidth, initialHeight;
      resizeHandle.addEventListener('mousedown', (e) => { isResizing = true; initialX=e.clientX; initialY=e.clientY; initialWidth=geminiContent.offsetWidth; initialHeight=geminiContent.offsetHeight; e.preventDefault(); });
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const newW = initialWidth + (e.clientX - initialX);
        const newH = initialHeight + (e.clientY - initialY);
        if (newW > 300) geminiContent.style.width = newW + 'px';
        if (newH > 300) geminiContent.style.height = newH + 'px';
      });

      function toggleGeminiSize() {
        if (originalGeminiState) {
          geminiContent.style.width = originalGeminiState.width;
          geminiContent.style.height = originalGeminiState.height;
          geminiContent.style.top = originalGeminiState.top;
          geminiContent.style.left = originalGeminiState.left;
          geminiContent.style.transform = originalGeminiState.transform;
          originalGeminiState = null;
        } else {
          originalGeminiState = {
            width: geminiContent.style.width,
            height: geminiContent.style.height,
            top: geminiContent.style.top,
            left: geminiContent.style.left,
            transform: geminiContent.style.transform
          };
          geminiContent.style.width = '100vw';
          geminiContent.style.height = '100vh';
          geminiContent.style.top = '0'; geminiContent.style.left = '0';
          geminiContent.style.transform = 'none';
        }
      }
      geminiHeader.addEventListener('dblclick', toggleGeminiSize);

      async function sendMessageToGemini(prompt) {
        const apiKey = currentApiKey;
        if (!apiKey) {
          showCustomAlert("No API key found. Please save your key in Settings to use this feature.");
          return "Please set your API key in the Settings to enable chat functionality.";
        }
        chatConversation.push({ role:'user', parts:[{ text: prompt }]});
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: chatConversation };
        const maxRetries = 3; let currentRetry = 0; let response = null;

        while (currentRetry < maxRetries) {
          try {
            response = await fetch(apiUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            if (response.ok) break;
            else if (response.status === 429) { const delay = Math.pow(2, currentRetry) * 1000; await new Promise(r => setTimeout(r, delay)); currentRetry++; }
            else { throw new Error(`API error: ${response.statusText}`); }
          } catch (error) { if (currentRetry >= maxRetries-1) throw error; currentRetry++; }
        }

        if (!response.ok) throw new Error('Failed to fetch after multiple retries.');
        const result = await response.json();
        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (text) { chatConversation.push({ role:'model', parts:[{ text }]}); return text; }
        return "Sorry, I couldn't generate a response. Please try again.";
      }

      // Convert lightweight markdown to HTML and keep math delimiters intact
      function mdToHtml(s) {
        // Bold **...** then italics *...*
        let html = s.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
        // Basic line breaks
        html = html.replace(/\n/g, '<br/>');
        return html;
      }

      // Display messages; typeset MathJax for BOTH user and Gemini messages
      function appendMessage(sender, text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'user' ? 'user-message' : 'gemini-message';
        messageDiv.innerHTML = mdToHtml(text);
        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        // Typeset just this message node once MathJax is ready
        setTimeout(() => {
          if (window.MathJax?.typesetPromise) {
            MathJax.typesetPromise([messageDiv]).catch(err => console.error('MathJax typeset error:', err));
          }
        }, 50);
      }

      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const prompt = chatInput.value.trim();
        if (!prompt) return;
        appendMessage('user', prompt);
        chatInput.value = '';
        chatInput.disabled = true;
        chatSendButton.innerHTML = `<span class="spinner"></span>`;
        chatSendButton.disabled = true;

        try {
          const geminiResponse = await sendMessageToGemini(prompt);
          appendMessage('gemini', geminiResponse);
        } catch (error) {
          appendMessage('gemini', "An error occurred. Please try again later.");
          console.error('Gemini chat error:', error);
        } finally {
          chatInput.disabled = false; chatInput.focus();
          chatSendButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/></svg>`;
          chatSendButton.disabled = false;
        }
      });

      function clearGeminiChat() {
        chatConversation = [];
        chatHistory.innerHTML = '';
        appendMessage('gemini',
`Hello! What would you like to talk about today?`);
      }
      newChatButton.addEventListener('click', clearGeminiChat);

      // Tabs
      todoTabButton.addEventListener('click', () => {
        todoTabButton.classList.add('active'); calendarTabButton.classList.remove('active');
        todoPanel.classList.remove('hidden'); calendarPanel.classList.add('hidden'); mainContainer.classList.remove('calendar-view');
      });
      calendarTabButton.addEventListener('click', () => {
        calendarTabButton.classList.add('active'); todoTabButton.classList.remove('active');
        calendarPanel.classList.remove('hidden'); todoPanel.classList.add('hidden'); mainContainer.classList.add('calendar-view');
      });

      // Calendar navigation
      prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });

      // Custom alert
      function showCustomAlert(message) { customAlertMessage.innerHTML = message; customAlertModal.classList.remove('hidden'); }
      closeAlertButton.addEventListener('click', () => { customAlertModal.classList.add('hidden'); });

      // Clock
      function updateClock() {
        const now = new Date();
        const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
        digitalClock.textContent = formatTime12Hour(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
        const secondsRatio = s/60, minutesRatio = (secondsRatio + m)/60, hoursRatio = (minutesRatio + h)/12;
        secondHand.style.transform = `rotate(${secondsRatio*360}deg)`;
        minuteHand.style.transform = `rotate(${minutesRatio*360}deg)`;
        hourHand.style.transform = `rotate(${hoursRatio*360}deg)`;
      }
      clockToggle.addEventListener('change', (e) => { localStorage.setItem(CLOCK_ENABLED_STORAGE_KEY, e.target.checked); updateClockVisibility(); });
      clockStyleSelect.addEventListener('change', (e) => { localStorage.setItem(CLOCK_STYLE_STORAGE_KEY, e.target.value); updateClockStyle(); });
      function updateClockVisibility(){ const on = localStorage.getItem(CLOCK_ENABLED_STORAGE_KEY) === 'true'; liveClock.classList.toggle('hidden', !on); }
      function updateClockStyle(){ const style = localStorage.getItem(CLOCK_STYLE_STORAGE_KEY) || 'digital'; if (style==='analog'){ digitalClock.classList.add('hidden'); analogClock.classList.remove('hidden'); } else { digitalClock.classList.remove('hidden'); analogClock.classList.add('hidden'); } }
      let isDraggingClock = false; let clockOffset = { x:0, y:0 };
      clockDragHandle.addEventListener('mousedown', (e) => { isDraggingClock = true; clockOffset.x = e.clientX - liveClock.getBoundingClientRect().left; clockOffset.y = e.clientY - liveClock.getBoundingClientRect().top; });
      document.addEventListener('mousemove', (e) => { if (isDraggingClock){ liveClock.style.left = `${e.clientX - clockOffset.x}px`; liveClock.style.top = `${e.clientY - clockOffset.y}px`; }});
      document.addEventListener('mouseup', () => { if(isDraggingClock){ localStorage.setItem(CLOCK_POSITION_STORAGE_KEY, JSON.stringify({ top: liveClock.style.top, left: liveClock.style.left })); } isDraggingClock = false; });
      function loadClockState() {
        const on = localStorage.getItem(CLOCK_ENABLED_STORAGE_KEY) === 'true';
        clockToggle.checked = on; updateClockVisibility();
        const style = localStorage.getItem(CLOCK_STYLE_STORAGE_KEY) || 'digital';
        clockStyleSelect.value = style; updateClockStyle();
        const pos = JSON.parse(localStorage.getItem(CLOCK_POSITION_STORAGE_KEY) || 'null'); if (pos){ liveClock.style.top = pos.top; liveClock.style.left = pos.left; }
      }

      // === Auth & sync ===
      const authView = document.getElementById('auth-view');
      const appView = document.getElementById('app-view');
      const authForm = document.getElementById('auth-form');
      const authEmail = document.getElementById('auth-email');
      const authPassword = document.getElementById('auth-password');
      const authSubmit = document.getElementById('auth-submit');
      const toggleAuthBtn = document.getElementById('toggle-auth-mode');
      const authModeText = document.getElementById('auth-mode-text');
      const authError = document.getElementById('auth-error');
      const signOutButton = document.getElementById('sign-out-button');
      const userEmailSpan = document.getElementById('user-email');

      let isRegisterMode = false;
      toggleAuthBtn.addEventListener('click', () => {
        isRegisterMode = !isRegisterMode;
        authSubmit.textContent = isRegisterMode ? 'Create account' : 'Log in';
        authModeText.textContent = isRegisterMode ? 'Already have an account?' : 'New here?';
        toggleAuthBtn.textContent = isRegisterMode ? 'Log in' : 'Create an account';
        authError.classList.add('hidden');
      });

      authForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        authSubmit.disabled = true;
        authSubmit.textContent = isRegisterMode ? 'Creating...' : 'Logging in...';
        authError.classList.add('hidden');
        try{
          if(isRegisterMode){
            await createUserWithEmailAndPassword(auth, authEmail.value.trim(), authPassword.value.trim());
          } else {
            await signInWithEmailAndPassword(auth, authEmail.value.trim(), authPassword.value.trim());
          }
        } catch(err){
          authError.textContent = err.message;
          authError.classList.remove('hidden');
        } finally {
          authSubmit.disabled = false;
          authSubmit.textContent = isRegisterMode ? 'Create account' : 'Log in';
        }
      });

      signOutButton.addEventListener('click', async ()=>{ try { await signOut(auth); } catch(e){ console.error('Sign out error', e); }});

      async function ensureUserDoc(){
        if(!userDocRef) return;
        const snap = await getDoc(userDocRef);
        if(!snap.exists()){
          await setDoc(userDocRef, {
            tasks: [], events: [],
            settings: collectSettingsFromLocal(),
            apiKey: null, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
          });
        }
      }

      function startUserSnapshot(){
        if(unsubscribeUserDoc) unsubscribeUserDoc();
        unsubscribeUserDoc = onSnapshot(userDocRef, (snap)=>{
          if(snap.exists()){
            const data = snap.data() || {};
            tasks = Array.isArray(data.tasks) ? data.tasks : [];
            events = Array.isArray(data.events) ? data.events : [];
            if (data.settings) applySettingsToUI(data.settings);
            currentApiKey = data.apiKey || null;
            sortTasksByDueDate(); renderApp();
          }
        }, (err)=> console.error('onSnapshot error', err));
      }

      onAuthStateChanged(auth, async (user)=>{
        currentUser = user || null;
        if(currentUser){
          userEmailSpan.textContent = currentUser.email || '';
          userEmailSpan.classList.remove('hidden');
          signOutButton.classList.remove('hidden');
          authView.classList.add('hidden');
          appView.classList.remove('hidden');

          userDocRef = doc(db, 'users', currentUser.uid);
          await ensureUserDoc();
          startUserSnapshot();
          saveAllDataFirestore();
        } else {
          if(unsubscribeUserDoc) unsubscribeUserDoc();
          userEmailSpan.classList.add('hidden');
          signOutButton.classList.add('hidden');
          appView.classList.add('hidden');
          authView.classList.remove('hidden');
          tasks = []; events = [];
        }
      });

      ['dark-mode-toggle','particles-toggle','logo-toggle','clock-toggle','clock-style','save-logo-url-button'].forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        const type = el.tagName==='BUTTON' ? 'click':'change';
        el.addEventListener(type, ()=> debounceSave());
      });
      document.addEventListener('mouseup', ()=>{ debounceSave(); });

      // Logout & Delete Account
      const logoutButton = document.getElementById('logout-button');
      const deleteAccountButton = document.getElementById('delete-account-button');

      if (logoutButton) {
        logoutButton.addEventListener('click', async () => {
          try { await signOut(auth); closeSettingsModal(); }
          catch (e) { console.error('Sign out failed:', e); showCustomAlert('Failed to sign out. Please try again.'); }
        });
      }

      if (deleteAccountButton) {
        deleteAccountButton.addEventListener('click', async () => {
          try {
            if (!currentUser) { showCustomAlert('You need to be logged in to delete your account.'); return; }
            tasks = []; events = [];
            try { if (!userDocRef) userDocRef = doc(db, 'users', currentUser.uid); await deleteDoc(userDocRef); } catch (e) { console.warn('User doc deletion warning:', e); }
            await deleteUser(currentUser);
            showCustomAlert('Your account has been deleted.'); closeSettingsModal();
          } catch (e) {
            console.error('Delete account error:', e);
            if (e?.code === 'auth/requires-recent-login') { showCustomAlert('For your security, please sign in again, then delete your account.'); }
            else { showCustomAlert('Could not delete account. Please try again.'); }
          }
        });
      }

      // Init
      window.onload = () => {
        loadTheme();
        loadParticlesState();
        loadLogoState();
        loadClockState();
        clearGeminiChat();
        animateBackground();
        setInterval(updateClock, 1000);
      };
    </script>
  </div> <!-- end #app-view -->
</body>
</html>
